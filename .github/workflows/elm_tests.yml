name: ELM matrix test

on:
    push:
        branches: [main]
        paths:
            - "Docker/**"
            - "model_examples/ELM/**"
            - "tools/**"
            - ".cime/**"
            - ".github/workflows/elm_tests.yml"
    pull_request:
        paths:
            - "Docker/**"
            - "model_examples/ELM/**"
            - "tools/**"
            - ".cime/**"
            - ".github/workflows/elm_tests.yml"
    schedule:
      - cron: "0 0 * * *"
    workflow_dispatch:

jobs:
    setup-cache:
      runs-on: ubuntu-latest
      steps:
        - name: Restore cached inputdata
          id: cache-inputdata
          uses: actions/cache@v4
          with:
            path: .cache/inputdata
            key: inputdata-v1-${{ hashFiles('tools/scripts/get_inputdata.sh') }}
            restore-keys: |
              inputdata-v1-

        - name: Prepare cache dirs
          run: |
            mkdir -p .cache/inputdata

        - name: Get input data (only if cache miss)
          if: steps.cache-inputdata.outputs.cache-hit != 'true'
          run: |
            docker run --rm \
              -v $(pwd):/home/modex_user \
              -v $(pwd)/.cache/inputdata:/mnt/inputdata \
              -v $(pwd)/.cache/output:/mnt/output \
              yuanfornl/ngee-arctic-modex26:models-main-latest \
              /home/modex_user/tools/scripts/get_inputdata.sh

### SMOKE TESTS
    test-era5:
      if: github.event_name != 'schedule'
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          site_name: [kougarok, teller, council, beo, toolik_lake, trail_valley_creek, abisko, samoylov_island, imnaviat_creek, upper_kuparuk]
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6
          with:
            submodules: recursive
        - name: Create docker volumes
          run: |
            docker volume create output
        - name: Run test case for site
          run: |
            docker run --rm -v $(pwd):/home/modex_user -v $(pwd)/.cache/inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/model_examples/ELM/run_ngeearctic_site.sh --site_name=${{matrix.site_name}} --met_source=era5 -ady=1 -fsy=1 -try=1 -tsp=1
        
    test-gswp3:
      if: github.event_name != 'schedule'
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          site_name: [kougarok, teller, council, beo, toolik_lake, trail_valley_creek, abisko, bayelva, samoylov_island, imnaviat_creek, upper_kuparuk]
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6
          with:
            submodules: recursive
        - name: Create docker volumes
          run: |
            docker volume create inputdata
            docker volume create output
        - name: Get input data
          run: docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/tools/scripts/get_inputdata.sh
        - name: Run test case for site
          run: |
            docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/model_examples/ELM/run_ngeearctic_site.sh --site_name=${{matrix.site_name}} --met_source=gswp3 -ady=1 -fsy=1 -try=1 -tsp=1

### LONG TESTS
    long-era5-tests:
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          site_name: [kougarok, teller, council, beo, toolik_lake, trail_valley_creek, abisko, samoylov_island, imnaviat_creek, upper_kuparuk]
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6
          with:
            submodules: recursive
        - name: Create docker volumes
          run: |
            docker volume create inputdata
            docker volume create output
        - name: Get input data
          run: docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/tools/scripts/get_inputdata.sh
        - name: Run test case for site
          run: |
            docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/model_examples/ELM/run_ngeearctic_site.sh --site_name=${{matrix.site_name}} --met_source=era5 -tsp=1
        
    long-gswp3-tests:
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          site_name: [kougarok, teller, council, beo, toolik_lake, trail_valley_creek, abisko, bayelva, samoylov_island, imnaviat_creek, upper_kuparuk]
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6
          with:
            submodules: recursive
        - name: Create docker volumes
          run: |
            docker volume create inputdata
            docker volume create output
        - name: Get input data
          run: docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/tools/scripts/get_inputdata.sh
        - name: Run test case for site
          run: |
            docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/model_examples/ELM/run_ngeearctic_site.sh --site_name=${{matrix.site_name}} --met_source=gswp3 -tsp=1
