name: TEM Tests

on:
    push:
        branches: [main]
        paths:
            - "Docker/**"
            - "model_examples/TEM/**"
            - "tools/**"
            - ".github/workflows/tem_tests.yml"
    pull_request:
        paths:
            - "Docker/**"
            - "model_examples/TEM/**"
            - "tools/**"
            - ".github/workflows/tem_tests.yml"
    schedule:
      - cron: "0 0 * * *"
    workflow_dispatch:

jobs:
### SHARED INPUT DATA PREPARATION
    prepare-inputdata:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6
        - name: Create docker volumes
          run: |
            docker volume create inputdata
        - name: Get input data
          run: |
            docker run --rm -v "$(pwd):/home/modex_user" -v inputdata:/mnt/inputdata yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/tools/scripts/get_inputdata.sh
        - name: Check whats in volume
          run: |
            docker run --rm -v inputdata:/mnt/inputdata alpine:latest ls -la /mnt/inputdata/
        - name: Copy input data to host for artifact storage
          run: |
            mkdir -p ./inputdata-cache
            docker run --rm -v inputdata:/mnt/inputdata -v "$(pwd)/inputdata-cache:/host/cache" alpine:latest sh -c 'cp -r /mnt/inputdata/* /host/cache/'
        - name: Upload input data as artifact
          uses: actions/upload-artifact@v4
          with:
            name: inputdata
            path: ./inputdata-cache
            retention-days: 1



### SMOKE TESTS
    tem-run-check:
      #needs: prepare-inputdata
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6

        - name: Test transient scenario glue script
          run: |
            docker run -i --rm -v "$(pwd):/home/modex_user" \
              -v inputdata:/mnt/inputdata \
              -v output:/mnt/output \
              yuanfornl/ngee-arctic-modex26:models-main-latest \
              bash -s <<'EOF'
              set -euo pipefail
              mkdir -p /tmp/TEM-tests
              pyddt-swd --input-data /opt/dvmdostem/demo-data/cru-ts40_ar5_rcp85_ncar-ccsm4_toolik_field_station_10x10/ --copy-inputs /tmp/TEM-tests/run_A
              cd /tmp/TEM-tests/run_A
              /home/modex_user/model_examples/TEM/glue_transient_scenario.py inputs/
              # Should confirm existence of stock-*.nc files
              TRANSIENT_YRS=$(python -c "import xarray; ds = xarray.open_dataset('inputs/historic-climate.nc'); print(int(ds.sizes['time']/12))")
              echo "Glued file is $TRANSIENT_YRS years long..."
              pyddt-runmask --reset --yx 0 0 inputs/run-mask.nc
              pyddt-outspec config/output_spec.csv --on GPP m p
              pyddt-outspec config/output_spec.csv --on LAYERDZ m l
              pyddt-outspec config/output_spec.csv --on TLAYER m l
              dvmdostem -f config/config.js -p 15 -e 10 -s 10 -t $TRANSIENT_YRS -n 0 -l monitor
            EOF

    tem-inputs-matrix:
      if: github.event_name != 'schedule'
      needs: prepare-inputdata
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          INPUT_DATASET:
          include:
            - INPUT_DATASET: modex26_1x1_AK-UTQ
              SHORT_NAME: ak-utq
            - INPUT_DATASET: cru-ts40_ar5_rcp85_ncar-ccsm4_toolik_field_station_10x10
              SHORT_NAME: toolik
            - INPUT_DATASET: cru-ts40_ar5_rcp85_ncar-ccsm4_CALM_Imnavait_Creek_MAT_10x10
              SHORT_NAME: imnavait
            - INPUT_DATASET: cru-ts40_ar5_rcp85_ncar-ccsm4_CALM_Kougarok_10x10
              SHORT_NAME: kougarok
            - INPUT_DATASET: cru-ts40_ar5_rcp85_ncar-ccsm4_EML_study_area_10x10
              SHORT_NAME: eml
            - INPUT_DATASET: cru-ts40_ar5_rcp85_ncar-ccsm4_KUPARUK_10x10
              SHORT_NAME: kuparuk
      steps:
        - name: Checkout repo
          uses: actions/checkout@v6
        - name: Create docker volumes
          run: |
            docker volume create inputdata
            docker volume create output
        - name: Download input data artifact
          uses: actions/download-artifact@v4
          with:
            name: inputdata
            path: ./inputdata-cache
        - name: Load input data into docker volume
          run: |
            docker run --rm -v inputdata:/mnt/inputdata -v "$(pwd)/inputdata-cache:/host/cache" alpine:latest sh -c 'cp -r /host/cache/* /mnt/inputdata/'

        - name: Run warming experiment for inputdata set
          run: |
            docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/model_examples/TEM/auto_test_run_warming_experiment.sh ${{matrix.INPUT_DATASET}}

        - name: Run breakout group experiments for input open_dataset
          run: |
            docker run --rm -v $(pwd):/home/modex_user -v inputdata:/mnt/inputdata -v output:/mnt/output yuanfornl/ngee-arctic-modex26:models-main-latest /home/modex_user/model_examples/TEM/auto_test_run_breakout.sh ${{matrix.INPUT_DATASET}} ${{matrix.SHORT_NAME}}