Hillslope hydrology and BGC impacts breakout group
==================================================

Objectives of the workshop breakout
-----------------------------------
Objectives of this workshop breakout is learn how to set up and run ELM
simulations to explore a set of four ELM confgurations:

+---------------------------+------------------+---------------------+------------------------------+
| Features                  | Spatial Extent   | Spatial Resolutions | Configuration name (CODE)    |
+===========================+==================+=====================+==============================+
| Topounits                 | Panarctic        | 0.5 deg             | Baseline (IM0_DS0)           |
+---------------------------+------------------+---------------------+------------------------------+
| Topounits                 | Panarctic        | 0.5 deg             |                              |
| + meteorology downscaling |                  |                     | Met. Downscaling (IM0_DS1)   |
+---------------------------+------------------+---------------------+------------------------------+
| Topounits                 | Panarctic        | 0.5 deg             |                              |
| + IM2 hillslope hydrology |                  |                     | Hillslope Hydrology (IM1_DS0)|
+---------------------------+------------------+---------------------+------------------------------+
| Topounits                 | Panarctic        | 0.5 deg             |                              |
| + meteorology downscaling |                  |                     | Met. Downscaling +           |
| + IM2 hillslope hydrology |                  |                     | Hillslope Hydrology (IM1_DS1)|
+---------------------------+------------------+---------------------+------------------------------+

Background on ELM features we will explore
------------------------------------------

Topounits
~~~~~~~~~
Topography-based subgrid scheme (or **Topounits**) and methods for
downscaling of atmospheric forcings were introduced in ELM by Tesfa et.
al. 2024 to better resolve terrestrial processes in regions of
heterogeneous terrain. 

::

    Tesfa, T. K., Leung, L. R., Thornton, P. E., Brunke, M. A., & Duan, Z. (2024). Impacts of Topography‐Based Subgrid Scheme and Downscaling of Atmospheric Forcing on Modeling Land Surface Processes in the Conterminous US. Journal of Advances in Modeling Earth Systems, 16(8). https://doi.org/10.1029/2023ms004064

Tesfa et. al. 2024 derived **topounits** from high resolution elevation data (90 m) for the half
degree grids. **Topounits**‐based surface properties (including PFTs,
soil texture etc.) input parameters were
generated by mapping grid‐level values onto the TGUs of each grid.

The algorithm extracts elevation values based on the boundary of the modeling unit (grid) and discretizes the
modeling unit into 12 initial subgrid units using the 12 percentile elevation values calculated to represent the
elevation values at each consecutive percentile (10th, 20th, 30th, 40th, 50th, 60th, 70th, 80th, 85th, 90th, 95th and
100th). Then, the 12 values of elevation range are determined using the minimum elevation value within each grid
and the corresponding percentile elevation values as class breaks.
Furthermore, the 100‐m elevation threshold value is used to
calculate new values of elevation class break using a recursive
algorithm developed by Tesfa et. al. 2024. The recursive
algorithm merges any elevation class with elevation range less than the
threshold value to its neighboring class recursively until all the classes with elevation range smaller than the threshold value are removed.
This allows the topography‐based subgrid scheme to capture the impacts of topographic heterogeneity while
minimizing computational demand of the model by varying the number of
**topounits** per grid depending on the topographic heterogeneity within each modeling unit.

.. figure:: ../_static/hillslope_bgc/Tesfa_2024_topounits_workflow.png
   :alt: Topounits workflow

.. list-table::
   :widths: 50 50
   :class: borderless

   * - .. figure:: ../_static/hillslope_bgc/toolik_dem_latlon.png
         :width: 100%

         Digital Elevation Model (DEM) near Toolik Field Station

     - .. figure:: ../_static/hillslope_bgc/toolik_dem_grouped.png
         :width: 100%

         Topounits (recursive merging) for Toolik Field Station identify 6 topounits

Plot below show the 12 percentile based elevation bins and the recursive
merge strategy to create the topounits.

.. figure:: ../_static/hillslope_bgc/toolik_elevation_summary.png
   :alt: Topounits workflow

Atmospheric Downscaling Scheme
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

IM2 Hillslope Hydrology
~~~~~~~~~~~~~~~~~~~~~~~

ELM Domain/Surface Datasets
-----------------------------------

ELM Domain Files
~~~~~~~~~~~~~~~~

ELM Surface Datasets
~~~~~~~~~~~~~~~~~~~~

ELM Forcing Files
~~~~~~~~~~~~~~~~~



Running ELM: Exercises on topographic unit, hereafter, topounit, data and functionality
---------------------------------------------------------------------------------------

In this series of ELM runs we will do following at NGEE Arctic's Council evaluation site
site name: council
site code: AK-SP-CL71
meteorological forcing source: gswp3

(1) a full-run of 3 stages of ELM simulations, but in short running years. 
(2) create a transient case, build it, but not run. 
(3) 4 sets of simulations, using the case setup and built in (2).

A quick test of ensential topounit enabled ELM run
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash

   docker run -it --rm \
     -v $(pwd):/home/modex_user \
     -v inputdata:/mnt/inputdata \
     -v output:/mnt/output \
     yuanfornl/ngee-arctic-modex26:models-main-latest \
     /home/modex_user/model_examples/ELM/run_ngeearctic_site.sh \
     --site_name=council \
     --topounits_atmdownscale \
     --case_prefix=topounit \
     --met_source=gswp3 \
     --ad_spinup_yrs=20 \
     --final_spinup_yrs=10 \
     --transient_yrs=10


The option, --topounits_atmdownscale, will turn on a function, downscaling air temperature and precipitation by topounit.
This function may significantly impact hydrology and may have consequent impacts on biogeochemical cycle, if mulitple topounits are properly created in ELM surface data.

Create a new transient case and build it.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash

   docker run -it --rm \
     -v $(pwd):/home/modex_user \
     -v inputdata:/mnt/inputdata \
     -v output:/mnt/output \
     yuanfornl/ngee-arctic-modex26:models-main-latest \
     /home/modex_user/model_examples/ELM/run_ngeearctic_site.sh \
     --site_name=council \
     --topounits_atmdownscale \
     --case_prefix=topounit \
     --met_source=gswp3 \
     --ad_spinup_yrs=0 \
     --final_spinup_yrs=0 \
     --no_submit
     
The option, --ad_spinup_yrs=0 will allow workflow SKIP ELM stage of biogeochimcally accelebrated spinup; --final_spinup_yrs=0 will SKIP stage of normal spinup.
Thus, it will create a case of Transient stage. Then, --no_submit will tell workflow not run the case.

From this command, 3 directories will generated for the case:
  CASE: topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC
  CASEROOT: /mnt/output/cime_case_dirs/topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC
  EXEROOT: /mnt/output/cime_run_dirs/topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC/bld
  RUNDIR: /mnt/output/cime_run_dirs/topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC/run

for convenience, CASEROOT has two parts:
    case_dir=/mnt/output/cime_case_dirs
    case_name=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC
    
EXEROOT is where 'e3sm.exe' and its building directory.
RUNDIR is where all simulation results are. Later on, when visualizing and/or analysing, all output data will be there.


Four (4) runs of the case just setup and built.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Topographic features along hillslope, may have 2 import thermal-hydrologically impacts on:
(1) near-surface temperature and precipitation. In ELM, this topounit function is called atmospheric forcing downscaling, i.e. topo-downscaling.
    TIP: For ELM developers, its namelist is use_atmdownscaling_to_topounit = .true., setup in ELM_BLDNML_OPTS ( "-topunit")
(2) water flow along hillslope. In ELM this topounit function is called IM2 hillslope hydrology.
    TIP: For ELM developers, its namelist is use_IM2_hillslope_hydrology = .true., setup in 'user_nl_name'


HERE, an ELM case re-run workflow, namely called run_ngeearctic_site_rerun.sh, will be used.

- It will run the already setup/built case, from a pre-run ending restart data packages.
- 4 runs will change run options differently, but no need to re-build model and implementation machine settings.

RUN 1: Baseline (IM0_DS1)

.. code-block:: bash

   docker run -it --rm \
     -v $(pwd):/home/modex_user \
     -v inputdata:/mnt/inputdata \
     -v output:/mnt/output \
     yuanfornl/ngee-arctic-modex26:models-main-latest \
     /home/modex_user/model_examples/ELM/run_ngeearctic_site_rerun.sh \
     --case_name=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --case_dirs=/mnt/output/cime_case_dirs \
     --run_type=branch \
     --restart_path=/mnt/inputdata/E3SM/lnd/clm2/inidata/council \
     --restart_case=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --restart_date=2005-01-01 \
     --continue_run_yrs=10 \
     --rest_yrs=11 \
     --user_namelist="topounit" \
     --merged_ncfile="MasterE3SM_subgrid.out_met-ds-NO_IM-2-NO_yes.topounit_gswp3_AK-SP-CL72_ICB20TRCNPRDCTCBC_2005.2014.nc"

NOTES: (1) --case_dirs, --case_name, will be the CASEROOT, which already existed.
       (2) --run_type=branch. This must be used together with --restart_path, --restart_case, --restart_date
       'branch' RUN_TYPE is one of 3 types supported here (startup, restart, and branch). It will find a few data and rpointer files in --restart_path, with case_name of --restart_case, from starting point time of --restart_date
       (3) --continue_run_yrs=10, it allows run goes for 10 years. So if starting from 2005-01-01, it will be ending at 2014-12-31.
       (4) --rest_yrs=11, tells model saves restart files every 11 years. Since the run only goes for 10 years, it won't generate restart files in this case. If intended to, have to set this to not greater than --continue_run_yrs.
       (5) --user_namelist="topounit", allows run configured as 'topounits' enabled, but no meteorological downscaling or IM2 hillslope hydrology
       (6) --merged_ncfile will tell workflow to save merged sub-grid output netCDF files to this file. Otherwise, its name is ELM_output_PFT.nc (and it will be overwritten by new run).
           It can be any name. Here we sort of intending it referring some meaningful name, e.g. E3SM version, not-grid-aggregated, met-ds (NO), IM-2 (NO), topounit (yes), met. type, site-code, ELM compset, period, etc.
       


RUN 2: Downscaling (IM0_DS0)

.. code-block:: bash

   docker run -it --rm \
     -v $(pwd):/home/modex_user \
     -v inputdata:/mnt/inputdata \
     -v output:/mnt/output \
     yuanfornl/ngee-arctic-modex26:models-main-latest \
     /home/modex_user/model_examples/ELM/run_ngeearctic_site_rerun.sh \
     --case_name=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --case_dirs=/mnt/output/cime_case_dirs \
     --run_type=branch \
     --restart_path=/mnt/inputdata/E3SM/lnd/clm2/inidata/council \
     --restart_case=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --restart_date=2005-01-01 \
     --continue_run_yrs=10 \
     --rest_yrs=11 \
     --user_namelist="topounit_atm_downscaling" \
     --merged_ncfile="MasterE3SM_subgrid.out_met-ds-YES_IM-2-NO_yes.topounit_gswp3_AK-SP-CL72_ICB20TRCNPRDCTCBC_2005.2014.nc"

NOTE:
       (5) --user_namelist="topounit_atm_downscalng", allows run configured as 'topounits' enabled PLUS meteorological downscaling.
       (6) --merged_ncfile


RUN 3: Hillslope Hydrology (IM1_DS0)

.. code-block:: bash

   docker run -it --rm \
     -v $(pwd):/home/modex_user \
     -v inputdata:/mnt/inputdata \
     -v output:/mnt/output \
     yuanfornl/ngee-arctic-modex26:models-main-latest \
     /home/modex_user/model_examples/ELM/run_ngeearctic_site_rerun.sh \
     --case_name=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --case_dirs=/mnt/output/cime_case_dirs \
     --run_type=branch \
     --restart_path=/mnt/inputdata/E3SM/lnd/clm2/inidata/council \
     --restart_case=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --restart_date=2005-01-01 \
     --continue_run_yrs=10 \
     --rest_yrs=11 \
     --user_namelist="topounit_IM2" \
     --merged_ncfile="MasterE3SM_subgrid.out_met-ds-NO_IM-2-YES_yes.topounit_gswp3_AK-SP-CL72_ICB20TRCNPRDCTCBC_2005.2014.nc"

NOTE:
       (5) --user_namelist="topounit_IM2", allows run configured as 'topounits' enabled PLUS IM2 hillslope hydrology.
       (6) --merged_ncfile

RUN 4: Met. Downscaling + Hillslope Hydrology (IM1_DS1)

.. code-block:: bash

   docker run -it --rm \
     -v $(pwd):/home/modex_user \
     -v inputdata:/mnt/inputdata \
     -v output:/mnt/output \
     yuanfornl/ngee-arctic-modex26:models-main-latest \
     /home/modex_user/model_examples/ELM/run_ngeearctic_site_rerun.sh \
     --case_name=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --case_dirs=/mnt/output/cime_case_dirs \
     --run_type=branch \
     --restart_path=/mnt/inputdata/E3SM/lnd/clm2/inidata/council \
     --restart_case=topounit_gswp3_AK-SP-CL71_ICB20TRCNPRDCTCBC \
     --restart_date=2005-01-01 \
     --continue_run_yrs=10 \
     --rest_yrs=11 \
     --user_namelist="topounit_atm_downscaling, topounit_IM2" \
     --merged_ncfile="MasterE3SM_subgrid.out_met-ds-YES_IM-2-YES_yes.topounit_gswp3_AK-SP-CL72_ICB20TRCNPRDCTCBC_2005.2014.nc"

NOTE:
       (5) --user_namelist="topounit_atm_downscalng, topounit_IM2", allows run configured as 'topounits' enabled PLUS meteorological downscaling and IM2 hillslope hydrology
       (6) --merged_ncfile


ELM run results visualizing and/or analysis
-------------------------------------------

Visualizing results using jupyter notebook container
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


Analysing Hillslope hydrology over topounits: soil moisture, GPP
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


